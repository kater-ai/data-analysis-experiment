-- How well did our employee perform in terms of hitting their sales quotas?

WITH
  RankedQuotas AS (
    SELECT
      sq.EMPLOYEEKEY,
      sq.DATEKEY,
      sq.SALESAMOUNTQUOTA,
      d.CALENDARYEAR,
      d.CALENDARQUARTER,
      ROW_NUMBER() OVER (
        PARTITION BY
          sq.EMPLOYEEKEY,
          d.CALENDARYEAR,
          d.CALENDARQUARTER
        ORDER BY
          sq.DATEKEY
      ) AS QuotaRank
    FROM
      KATER.ADVENTUREWORKSDW.FACTSALESQUOTA sq
      JOIN KATER.ADVENTUREWORKSDW.DIMDATE d ON sq.DATEKEY = d.DATEKEY
  )
SELECT
  e.FIRSTNAME,
  e.LASTNAME,
  d.CALENDARYEAR,
  d.CALENDARQUARTER,
  rq.DATEKEY,
  SUM(f.SALESAMOUNT) AS TotalSales,
  rq.SALESAMOUNTQUOTA,
  SUM(f.SALESAMOUNT) - rq.SALESAMOUNTQUOTA AS SalesMinusQuota
FROM
  KATER.ADVENTUREWORKSDW.FACTRESELLERSALES f
  LEFT JOIN KATER.ADVENTUREWORKSDW.DIMDATE d ON f.ORDERDATEKEY = d.DATEKEY
  LEFT JOIN RankedQuotas rq ON f.ORDERDATEKEY = rq.DATEKEY
  AND f.EMPLOYEEKEY = rq.EMPLOYEEKEY
  AND rq.QuotaRank = 1
  LEFT JOIN KATER.ADVENTUREWORKSDW.DIMEMPLOYEE e ON rq.EMPLOYEEKEY = e.EMPLOYEEKEY
GROUP BY
  e.FIRSTNAME,
  e.LASTNAME,
  d.CALENDARYEAR,
  d.CALENDARQUARTER,
  rq.DATEKEY,
  rq.SALESAMOUNTQUOTA
ORDER BY
  e.LASTNAME,
  e.FIRSTNAME,
  d.CALENDARYEAR,
  d.CALENDARQUARTER;